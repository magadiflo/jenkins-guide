# ‚öôÔ∏è Parametrizando Jenkins Jobs

---

## üß© Agregando par√°metros

Iniciamos creando una `nueva vista`. La opci√≥n `"Nueva vista" (New View)` en el panel principal de `Jenkins` sirve para
*crear una p√°gina personalizada que agrupa y muestra un subconjunto espec√≠fico de tus trabajos (`Jobs`).*

üí° Concepto clave:
> Una vista es una forma de `organizar y filtrar proyectos`, ideal cuando tienes muchos `Jobs` y deseas agruparlos
> seg√∫n un equipo, prop√≥sito o entorno espec√≠fico.

### ‚ûï Creaci√≥n de la vista

Damos clic en el √≠cono del m√°s `(+)`.

![01.jpg](assets/section-05/01.png)

Asignamos un nombre ‚Äîpor ejemplo‚Äî `Jobs Parametrizados`. En la secci√≥n `Type` se nos presentan dos opciones:

- üßæ `Lista de vistas`: muestra proyectos en formato de lista.
- üîí `Mi vista`: muestra tareas a las que el usuario tiene acceso directo.

Seleccionamos `Lista de vistas` y presionamos `Create`.

![02.png](assets/section-05/02.png)

Agregamos una peque√±a descripci√≥n a nuestra vista y damos clic en `Save`.

![03.png](assets/section-05/03.png)

A continuaci√≥n veremos nuestra vista reci√©n creada `Jobs Parametrizados`, donde agruparemos los distintos `Jobs` que
configuraremos en esta secci√≥n.

![04.png](assets/section-05/04.png)

üí° Nota:
> `Jenkins` crea autom√°ticamente la vista `Todo (All)` donde se listan todos los `Jobs del sistema`. En cambio,
> en nuestra nueva vista solo aparecer√°n los `Jobs` que agreguemos manualmente.

![05.png](assets/section-05/05.png)

### üß± Creando un nuevo Job parametrizado

Con la vista `Jobs Parametrizados` seleccionada, damos clic en `Nueva tarea`.

![06.png](assets/section-05/06.png)

Le asignamos el nombre `Job Parametrizado 1`, elegimos `Crear un proyecto de estilo libre`, y verificamos que el
check `Add to current view` est√© activado, para a√±adirlo a la vista actual.

![07.png](assets/section-05/07.png)

### üßπ Configuraci√≥n b√°sica de mantenimiento

Habilitamos la opci√≥n `Desechar ejecuciones antiguas`, que controla la `retenci√≥n de logs`, `artefactos` y
`metadatos` de compilaciones pasadas.

Podemos definir los criterios de eliminaci√≥n usando:

- ‚è≥ `Build age`: descarta compilaciones despu√©s de cierta antig√ºedad (por ejemplo, 7 d√≠as).
- üî¢ `Build count`: mantiene un n√∫mero m√°ximo de compilaciones (por ejemplo, 50).

En nuestro caso:

- **N√∫mero de d√≠as para mantener ejecuciones:** 5
- **N√∫mero m√°ximo de ejecuciones:** 6

![08.png](assets/section-05/08.png)

### üíª A√±adiendo un paso de construcci√≥n

En la secci√≥n `Build Steps`, seleccionamos la opci√≥n `Ejecutar l√≠nea de comandos (shell)`.

![09.png](assets/section-05/09.png)

### üìú Creando el script `params_script.sh`

Antes de mostrar la vista `Ejecutar linea de comandos (shell)` vamos a crear un nuevo script en este proyecto llamado
`params_script.sh`. Como observamos, este script no tiene las variables `NAME` ni `COURSE` inicializadas, dado que
se espera que estas variables est√©n disponibles en el entorno de Jenkins cuando los agreguemos a trav√©s de su interfaz.

````bash
#!/bin/bash

# --------------------------------------------------------------------------------------
# Este script NO declara las variables NAME y COURSE internamente.
#
# La raz√≥n es que este script est√° dise√±ado para ser ejecutado como un paso
# de 'Execute shell' en un Job de Jenkins configurado como Parametrizado.
#
# Jenkins inyectar√° autom√°ticamente los valores para las variables de entorno
# $NAME y $COURSE (definidas en la configuraci√≥n del Job) antes de ejecutar el script.
#
# Al no redefinirlas aqu√≠, se garantiza que los valores pasados desde la interfaz
# de usuario de Jenkins son los que se utilizar√°n durante la ejecuci√≥n.
# --------------------------------------------------------------------------------------

# Empieza el loop
for i in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
do
	# Si i = 8, el loop se detiene moment√°neamente
    if [ ${i} -eq 8 ]; then
    	# Dormir 5 segundos
        sleep 5
        echo "A descansar de clase ${COURSE}"
    fi
    echo "Clase N¬∞ ${i}"
done

# Dormir 5 segundos
sleep 5
echo "Bien ${NAME}, terminamos las clases de ${COURSE}, ¬°nos vemos!"
````

üìÇ Copiamos el script dentro del contenedor de `Jenkins`.

````bash
D:\programming\jenkins\jenkins-guide (section-05)
$ docker container cp .\scripts\params_script.sh c-jenkins:/opt
Successfully copied 3.07kB to c-jenkins:/opt
````

Podemos ejecutar el siguiente comando para ver el contendio del archivo `params_script.sh` dentro del contenedor de
jenkins.

````bash
$ docker container exec c-jenkins cat /opt/params_script.sh
#!/bin/bash

# --------------------------------------------------------------------------------------
# Este script NO declara las variables NAME y COURSE internamente.
#
# La raz√≥n es que este script est√° dise√±ado para ser ejecutado como un paso
# de 'Execute shell' en un Job de Jenkins configurado como Parametrizado.
#
# Jenkins inyectar√° autom√°ticamente los valores para las variables de entorno
# $NAME y $COURSE (definidas en la configuraci√≥n del Job) antes de ejecutar el script.
#
# Al no redefinirlas aqu√≠, se garantiza que los valores pasados desde la interfaz
# de usuario de Jenkins son los que se utilizar√°n durante la ejecuci√≥n.
# --------------------------------------------------------------------------------------

# Empieza el loop
for i in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15
do
        # Si i = 8, el loop se detiene moment√°neamente
    if [ ${i} -eq 8 ]; then
        # Dormir 5 segundos
        sleep 5
        echo "A descansar de clase ${COURSE}"
    fi
    echo "Clase N¬∞ ${i}"
done

# Dormir 5 segundos
sleep 5
echo "Bien ${NAME}, terminamos las clases de ${COURSE}, ¬°nos vemos!" 
````

### ‚öôÔ∏è Configurando la ejecuci√≥n en Jenkins

En el campo de `Ejecutar linea de comandos (shell)`, escribimos la ruta al script dentro del contenedor:
`/opt/params_script.sh`.

![10.png](assets/section-05/10.png)

### üß† Habilitando la parametrizaci√≥n del Job

Marcamos la opci√≥n `Esta ejecuci√≥n debe parametrizarse` y a√±adimos par√°metros de cadena (String parameters) para las
variables esperadas: `NAME` y `COURSE`.

![11.png](assets/section-05/11.png)

Definimos cada par√°metro con su valor predeterminado:

- `NAME` = Milagros
- `COURSE` = La Gu√≠a de Jenkins

![12.png](assets/section-05/12.png)

![13.png](assets/section-05/13.png)

### üöÄ Ejecutando el Job parametrizado

Al guardar la configuraci√≥n, se habilita la opci√≥n `Build with Parameters`. All√≠ podemos ajustar los valores de `NAME`
y `COURSE` antes de ejecutar. En nuestro caso ejecutamos con los valores por defecto:

![14.png](assets/section-05/14.png)

Finalmente, abrimos el `Console Output` y observamos c√≥mo `Jenkins` interpreta y usa los valores inyectados.

![15.png](assets/section-05/15.png)

üí° Resultado esperado:
> El script imprime las iteraciones del bucle, realiza una pausa intermedia y muestra los mensajes personalizados con
> los valores definidos.

### üß≠ Conclusi√≥n

En esta lecci√≥n aprendimos a:

- Organizar Jobs mediante `vistas personalizadas`.
- Crear un `Job parametrizado` con variables de entorno inyectadas desde `Jenkins`.
- Ejecutar scripts externos y observar c√≥mo Jenkins pasa din√°micamente los par√°metros definidos por el usuario.
