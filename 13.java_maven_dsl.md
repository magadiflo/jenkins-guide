# ðŸš€ SecciÃ³n 13: Java Maven DSL

---

## ðŸ”“ Deshabilitando la seguridad de scripts para los Job DSL

Cuando trabajamos con `Job DSL` (Domain Specific Language) en Jenkins, es comÃºn que despuÃ©s de modificar algÃºn script
â€”especialmente en el `Seed Job`â€” `Jenkins bloquee la ejecuciÃ³n hasta que el administrador apruebe manualmente` el
contenido del DSL. Esto ocurre porque, por defecto, `Jenkins` aplica un mecanismo de `Script Security` para evitar
que scripts potencialmente maliciosos afecten la configuraciÃ³n del servidor.

Sin embargo, mientras desarrollamos y hacemos iteraciones rÃ¡pidas, este proceso puede ser molesto e innecesario. Para
entornos de prueba o aprendizaje, podemos `deshabilitar temporalmente esta validaciÃ³n`.

### âš ï¸ Advertencia importante (mundo real)

En entornos corporativos o servidores Jenkins compartidos, nunca desactives la seguridad de scripts.
Las empresas mantienen esta opciÃ³n activada para evitar que alguien ejecute un DSL que modifique trabajos, agentes o
ejecuciones sin control.

La opciÃ³n solo conviene desactivarla cuando:

- "estÃ¡s en un Jenkins local",
- "estÃ¡s en un ambiente sandbox",
- "o eres administrador y sabes exactamente quÃ© scripts se ejecutarÃ¡n".

### ðŸ› ï¸ Pasos para deshabilitar la Script Security en DSL

Para permitir que Jenkins ejecute los scripts sin solicitar aprobaciÃ³n manual:

1. Ir a Manage Jenkins (Administrar Jenkins).
2. Seleccionar Security.
3. Desmarcar la opciÃ³n: `Enable script security for Job DSL scripts`
4. Guardar los cambios.

![01.png](assets/section-13/01.png)

## ðŸ§© Contexto previo antes de la creaciÃ³n de los Jobs

En la `SecciÃ³n 7: IntegraciÃ³n de Jenkins con una App Java + Maven`, creamos manualmente el job `java_app_con_maven`
y ahÃ­ configuramos:

- ðŸ“¦ Origen del cÃ³digo fuente (repositorio Git)
- ðŸ—ï¸ Build Steps (comandos Maven para compilar, ejecutar tests y empaquetar el .jar)
- ðŸ“¬ Notificaciones por correo
- ðŸ’¬ Notificaciones por Slack
- ðŸ“ PublicaciÃ³n de reportes de pruebas JUnit

En resumen, construimos un `job clÃ¡sico configurado manualmente desde la UI de Jenkins`.

![02.png](assets/section-13/02.png)

### ðŸ” Â¿QuÃ© cambia en esta SecciÃ³n 13?

En esta secciÃ³n daremos un paso importante hacia la automatizaciÃ³n real: vamos a reemplazar la configuraciÃ³n manual
por una configuraciÃ³n declarativa usando `Job DSL scripts`.

#### ðŸŽ¯ Â¿QuÃ© significa esto?

Toda la configuraciÃ³n que antes hacÃ­amos clic por clic en la interfaz ahora la definiremos mediante cÃ³digo `.groovy`,
dentro de un `Seed Job` (job padre).

Luego, solo debemos `ejecutar ese Seed Job`, y Jenkins:

- GenerarÃ¡ automÃ¡ticamente el job hijo.
- AplicarÃ¡ toda la configuraciÃ³n especificada en el DSL.
- MantendrÃ¡ una configuraciÃ³n reproducible y versionable.

#### ðŸ’¼ Â¿Por quÃ© esto es importante en el mundo real?

En entornos profesionales, la configuraciÃ³n manual en Jenkins se considera una mala prÃ¡ctica, porque:

- âŒ No se versiona.
- âŒ Es difÃ­cil replicar en nuevos entornos (QA, Stage, Prod).
- âŒ No es auditable.
- âŒ Depende de la memoria del operador ("Â¿quÃ© checkbox activÃ© la vez pasada?").

Con `Job DSL` o `Pipeline-as-Code` (Jenkinsfile):

- âœ”ï¸ La configuraciÃ³n estÃ¡ en Git.
- âœ”ï¸ La creaciÃ³n de jobs es idÃ©ntica entre entornos.
- âœ”ï¸ Puedes hacer PRs para revisar cambios.
- âœ”ï¸ Evitas configuraciones inconsistentes.
- âœ”ï¸ Puedes reconstruir toda la estructura de jobs desde cero.

ðŸ’¡ Nota:

Aunque `DSL Job` ha sido muy usado, muchas empresas estÃ¡n migrando a `Multibranch Pipelines` y `Pipeline-as-Code`.
Sin embargo, `Job DSL` sigue siendo Ãºtil para:

- Generar estructuras de carpetas.
- Crear plantillas de jobs.
- Crear cientos de jobs parametrizados.
- Automatizar la gestiÃ³n del propio Jenkins.

## ðŸ“ CreaciÃ³n de Jobs con Job DSL â€“ Script Integrado (In-line)

En esta lecciÃ³n aprenderemos la primera forma de generar jobs con `Job DSL`, colocando el cÃ³digo
`directamente dentro del Seed Job`. Esta tÃ©cnica se conoce como `Inline DSL (o Script Integrado)`, porque el cÃ³digo
`.groovy` vive en la misma configuraciÃ³n del Job y no en un archivo externo.

âš ï¸ Nota profesional (mundo real):
> Las empresas suelen evitar el `DSL inline`, porque no se versiona en Git. Se usa solo para prototipos,
> sandbox y pruebas. MÃ¡s adelante veremos la forma correcta y profesional: `DSL desde archivos externos versionados`.

### ðŸŒ± Creando el Seed Job (Job Padre)

Creamos un nuevo job de tipo Freestyle Job con el nombre: `seed-job-dsl-integrated`.

![03.png](assets/section-13/03.png)

### âš™ï¸ Configurando el Seed Job para procesar DSL

Una vez creado el job:

1. Entramos a `Configurar`
2. Bajamos a `Build Steps`
3. Seleccionamos `Add build step` â†’ `Process Job DSLs`
4. Y elegimos la opciÃ³n: `Use the provided DSL script`

![04.png](assets/section-13/04.png)

En este modo escribiremos el cÃ³digo DSL directamente en el cuadro de texto del Seed Job.

### ðŸ“š Archivo de referencia del repositorio

La siguiente imagen muestra el archivo `javamavenDSL.groovy`. Este archivo se encuentra en el subdirectorio `DSL/`
de nuestro repositorio forkeado
(referencia: https://github.com/magadiflo/simple-java-maven-app/blob/master/DSL/javamavenDSL.groovy).
Contiene el cÃ³digo `Groovy DSL` que utilizaremos como plantilla para definir nuestros Jobs en Jenkins.

![05.png](assets/section-13/05.png)

Tomamos ese archivo como referencia para escribir nuestro propio DSL, aplicando pequeÃ±as mejoras.

### ðŸ§± CÃ³digo DSL (Groovy) Modificado

AquÃ­ estÃ¡ la versiÃ³n del script que usaremos dentro del `Seed Job`:

````groovy
job('java-app-con-maven-dsl') {
    description('Java Maven App con DSL para el curso de Jenkins')
    scm {
        git('https://github.com/magadiflo/simple-java-maven-app.git', 'master') { node ->
            node / gitConfigName('MartÃ­n DÃ­az')
            node / gitConfigEmail('magadiflo@gmail.com')
        }
    }
    steps {
        maven {
            mavenInstallation('Maven en Jenkins')
            goals('-B -DskipTests clean package')
        }
        maven {
            mavenInstallation('Maven en Jenkins')
            goals('test')
        }
        shell('''
          echo "Entrega: Desplegando la aplicaciÃ³n" 
          java -jar /var/jenkins_home/workspace/java-app-con-maven-dsl/target/my-app-1.0-SNAPSHOT.jar
        ''')
    }
    publishers {
        archiveArtifacts('target/*.jar')
        archiveJunit('target/surefire-reports/*.xml')
        slackNotifier {
            notifyAborted(true)
            notifyEveryFailure(true)
            notifyNotBuilt(false)
            notifyUnstable(false)
            notifyBackToNormal(true)
            notifySuccess(true)
            notifyRepeatedFailure(false)
            startNotification(false)
            includeTestSummary(false)
            includeCustomMessage(false)
            customMessage(null)
            sendAs(null)
            commitInfoChoice('NONE')
            teamDomain(null)
            authToken(null)
        }
    }
}
````

### ðŸ§© Â¿QuÃ© hace este cÃ³digo DSL Groovy?

Este script define un job de Jenkins completamente desde cÃ³digo. Lo mÃ¡s importante que realiza es:

#### ðŸ”§ 1. CreaciÃ³n del Job

- Crea un job llamado `java-app-con-maven-dsl`.
- Le asigna una descripciÃ³n visible en la UI.

#### ðŸ“¥ 2. ConfiguraciÃ³n del SCM (Git)

- Clona el repositorio: https://github.com/magadiflo/simple-java-maven-app.git
- Usa la rama `master`.
- Registra nombre y correo para identificar los commits en Jenkins (metadatos).

#### ðŸ—ï¸ 3. EjecuciÃ³n de Builds con Maven

El core del job para Java:

- Usa la instalaciÃ³n de Maven llamada `Maven en Jenkins`.
- El nombre `Maven en Jenkins` debe coincidir exactamente con la instalaciÃ³n de Maven definida en:
  `Administrar Jenkins` â†’ `Tools` â†’ `Instalaciones de Maven`.
- Ejecuta dos pasos Maven:
    1. `-B -DskipTests clean package` â†’ compila y empaqueta el JAR sin correr tests.
    2. `test` â†’ ejecuta las pruebas unitarias.

> Esto reproduce el pipeline clÃ¡sico de proyectos Java: `compilar` â†’ `empaquetar` â†’ `probar`.

![06.png](assets/section-13/06.png)

#### ðŸš€ 4. EjecuciÃ³n de la aplicaciÃ³n Java

- Usa un paso `shell` para lanzar el `.jar` generado.
- Ejecuta: `java -jar /var/jenkins_home/workspace/java-app-con-maven-dsl/target/my-app-1.0-SNAPSHOT.jar`.
- Esto demuestra que el build generÃ³ un artefacto vÃ¡lido.

#### ðŸ“¦ 5. PublicaciÃ³n de artefactos

- Guarda el `.jar` como artefacto descargable.
- Publica resultados de pruebas `JUnit` desde `surefire-reports`.

#### ðŸ’¬ 6. Notificaciones por Slack

Configura el plugin de `Slack` para enviar notificaciones segÃºn el resultado del job (`fallo`, `Ã©xito`, `inestable`,
`abortado`, etc.).

#### ðŸŽ¯ Resumen breve

El script crea un job completo que:

- Clona un proyecto Java/Maven desde Git
- Compila y empaqueta la aplicaciÃ³n
- Ejecuta tests
- Corre la aplicaciÃ³n Java
- Publica el `.jar` y reportes de pruebas
- Notifica a Slack los resultados

> Todo esto `sin tocar la interfaz grÃ¡fica`, demostrando cÃ³mo Job DSL convierte una configuraciÃ³n manual en un proceso
> totalmente automatizado.

### ðŸ§© Colocando el cÃ³digo DSL en el Seed Job

En el Seed Job entramos a: `Build Steps` â†’ `Process Job DSLs` â†’ `Use the provided DSL script` y
pegamos el cÃ³digo `.groovy`.

![07.png](assets/section-13/07.png)

Guardamos los cambios.

### â–¶ï¸ Ejecutando el Seed Job

Damos clic en `Construir ahora` en el job `seed-job-dsl-integrated`. Una vez completado el build, veremos que
Jenkins generÃ³ automÃ¡ticamente un nuevo job: `java-app-con-maven-dsl`

![08.png](assets/section-13/08.png)

TambiÃ©n aparece correctamente en la pantalla principal:

![09.png](assets/section-13/09.png)

### ðŸ”§ Verificando la configuraciÃ³n generada

Ingresamos a `Configurar` dentro del job reciÃ©n creado (`java-app-con-maven-dsl`) y confirmamos que todas las opciones
(`SCM`, `Maven`, `Slack`, `JUnit`, `shell`, etc.) fueron aplicadas exactamente como estaban en el `cÃ³digo DSL`.

![10.png](assets/section-13/10.png)

### â–¶ï¸ Ejecutando el job generado

Ahora ejecutamos el job `java-app-con-maven-dsl` con `Construir ahora` y vemos que se ejecuta correctamente:

![11.png](assets/section-13/11.png)

Y en los logs aparece:

- La ejecuciÃ³n de `Maven`
- El despliegue del `.jar`
- El mensaje final `SUCCESS`

![12.png](assets/section-13/12.png)

### âœ… Resumen

En esta primera aproximaciÃ³n:

- Creamos un Seed Job bÃ¡sico.
- Pegamos el `DSL Groovy` directamente dentro del job.
- Generamos un job completo sin tocar la UI de Jenkins.
- Confirmamos que todo funciona: build, artefactos, test, notificaciones, ejecuciÃ³n del .jar

> ðŸŒŸ `Este es el primer paso hacia CI/CD completamente automatizado`. En los siguientes apartados veremos formas mÃ¡s
> profesionales y mantenibles de trabajar con DSL.
