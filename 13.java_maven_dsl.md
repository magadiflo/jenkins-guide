# üöÄ Secci√≥n 13: Java Maven DSL

---

## üîì Deshabilitando la seguridad de scripts para los Job DSL

Cuando trabajamos con `Job DSL` (Domain Specific Language) en Jenkins, es com√∫n que despu√©s de modificar alg√∫n script
‚Äîespecialmente en el `Seed Job`‚Äî `Jenkins bloquee la ejecuci√≥n hasta que el administrador apruebe manualmente` el
contenido del DSL. Esto ocurre porque, por defecto, `Jenkins` aplica un mecanismo de `Script Security` para evitar
que scripts potencialmente maliciosos afecten la configuraci√≥n del servidor.

Sin embargo, mientras desarrollamos y hacemos iteraciones r√°pidas, este proceso puede ser molesto e innecesario. Para
entornos de prueba o aprendizaje, podemos `deshabilitar temporalmente esta validaci√≥n`.

### ‚ö†Ô∏è Advertencia importante (mundo real)

En entornos corporativos o servidores Jenkins compartidos, nunca desactives la seguridad de scripts.
Las empresas mantienen esta opci√≥n activada para evitar que alguien ejecute un DSL que modifique trabajos, agentes o
ejecuciones sin control.

La opci√≥n solo conviene desactivarla cuando:

- "est√°s en un Jenkins local",
- "est√°s en un ambiente sandbox",
- "o eres administrador y sabes exactamente qu√© scripts se ejecutar√°n".

### üõ†Ô∏è Pasos para deshabilitar la Script Security en DSL

Para permitir que Jenkins ejecute los scripts sin solicitar aprobaci√≥n manual:

1. Ir a Manage Jenkins (Administrar Jenkins).
2. Seleccionar Security.
3. Desmarcar la opci√≥n: `Enable script security for Job DSL scripts`
4. Guardar los cambios.

![01.png](assets/section-13/01.png)

## üß© Contexto previo antes de la creaci√≥n de los Jobs

En la `Secci√≥n 7: Integraci√≥n de Jenkins con una App Java + Maven`, creamos manualmente el job `java_app_con_maven`
y ah√≠ configuramos:

- üì¶ Origen del c√≥digo fuente (repositorio Git)
- üèóÔ∏è Build Steps (comandos Maven para compilar, ejecutar tests y empaquetar el .jar)
- üì¨ Notificaciones por correo
- üí¨ Notificaciones por Slack
- üìù Publicaci√≥n de reportes de pruebas JUnit

En resumen, construimos un `job cl√°sico configurado manualmente desde la UI de Jenkins`.

![02.png](assets/section-13/02.png)

### üîÅ ¬øQu√© cambia en esta Secci√≥n 13?

En esta secci√≥n daremos un paso importante hacia la automatizaci√≥n real: vamos a reemplazar la configuraci√≥n manual
por una configuraci√≥n declarativa usando `Job DSL scripts`.

#### üéØ ¬øQu√© significa esto?

Toda la configuraci√≥n que antes hac√≠amos clic por clic en la interfaz ahora la definiremos mediante c√≥digo `.groovy`,
dentro de un `Seed Job` (job padre).

Luego, solo debemos `ejecutar ese Seed Job`, y Jenkins:

- Generar√° autom√°ticamente el job hijo.
- Aplicar√° toda la configuraci√≥n especificada en el DSL.
- Mantendr√° una configuraci√≥n reproducible y versionable.

#### üíº ¬øPor qu√© esto es importante en el mundo real?

En entornos profesionales, la configuraci√≥n manual en Jenkins se considera una mala pr√°ctica, porque:

- ‚ùå No se versiona.
- ‚ùå Es dif√≠cil replicar en nuevos entornos (QA, Stage, Prod).
- ‚ùå No es auditable.
- ‚ùå Depende de la memoria del operador ("¬øqu√© checkbox activ√© la vez pasada?").

Con `Job DSL` o `Pipeline-as-Code` (Jenkinsfile):

- ‚úîÔ∏è La configuraci√≥n est√° en Git.
- ‚úîÔ∏è La creaci√≥n de jobs es id√©ntica entre entornos.
- ‚úîÔ∏è Puedes hacer PRs para revisar cambios.
- ‚úîÔ∏è Evitas configuraciones inconsistentes.
- ‚úîÔ∏è Puedes reconstruir toda la estructura de jobs desde cero.

üí° Nota:

Aunque `DSL Job` ha sido muy usado, muchas empresas est√°n migrando a `Multibranch Pipelines` y `Pipeline-as-Code`.
Sin embargo, `Job DSL` sigue siendo √∫til para:

- Generar estructuras de carpetas.
- Crear plantillas de jobs.
- Crear cientos de jobs parametrizados.
- Automatizar la gesti√≥n del propio Jenkins.

## üìù Creaci√≥n de Jobs con Job DSL ‚Äì Script Integrado (In-line)

En esta lecci√≥n aprenderemos la primera forma de generar jobs con `Job DSL`, colocando el c√≥digo
`directamente dentro del Seed Job`. Esta t√©cnica se conoce como `Inline DSL (o Script Integrado)`, porque el c√≥digo
`.groovy` vive en la misma configuraci√≥n del Job y no en un archivo externo.

‚ö†Ô∏è Nota profesional (mundo real):
> Las empresas suelen evitar el `DSL inline`, porque no se versiona en Git. Se usa solo para prototipos,
> sandbox y pruebas. M√°s adelante veremos la forma correcta y profesional: `DSL desde archivos externos versionados`.

### üå± Creando el Seed Job (Job Padre)

Creamos un nuevo job de tipo Freestyle Job con el nombre: `seed-job-dsl-integrated`.

![03.png](assets/section-13/03.png)

### ‚öôÔ∏è Configurando el Seed Job para procesar DSL

Una vez creado el job:

1. Entramos a `Configurar`
2. Bajamos a `Build Steps`
3. Seleccionamos `Add build step` ‚Üí `Process Job DSLs`
4. Y elegimos la opci√≥n: `Use the provided DSL script`

![04.png](assets/section-13/04.png)

En este modo escribiremos el c√≥digo DSL directamente en el cuadro de texto del Seed Job.

### üìö Archivo de referencia del repositorio

La siguiente imagen muestra el archivo `javamavenDSL.groovy`. Este archivo se encuentra en el subdirectorio `DSL/`
de nuestro repositorio forkeado
(referencia: https://github.com/magadiflo/simple-java-maven-app/blob/master/DSL/javamavenDSL.groovy).
Contiene el c√≥digo `Groovy DSL` que utilizaremos como plantilla para definir nuestros Jobs en Jenkins.

![05.png](assets/section-13/05.png)

Tomamos ese archivo como referencia para escribir nuestro propio DSL, aplicando peque√±as mejoras.

### üß± C√≥digo DSL (Groovy) Modificado

Aqu√≠ est√° la versi√≥n del script que usaremos dentro del `Seed Job`:

````groovy
job('java-app-con-maven-dsl') {
    description('Java Maven App con DSL para el curso de Jenkins')
    scm {
        git('https://github.com/magadiflo/simple-java-maven-app.git', 'master') { node ->
            node / gitConfigName('Mart√≠n D√≠az')
            node / gitConfigEmail('magadiflo@gmail.com')
        }
    }
    steps {
        maven {
            mavenInstallation('Maven en Jenkins')
            goals('-B -DskipTests clean package')
        }
        maven {
            mavenInstallation('Maven en Jenkins')
            goals('test')
        }
        shell('''
          echo "Entrega: Desplegando la aplicaci√≥n" 
          java -jar /var/jenkins_home/workspace/java-app-con-maven-dsl/target/my-app-1.0-SNAPSHOT.jar
        ''')
    }
    publishers {
        archiveArtifacts('target/*.jar')
        archiveJunit('target/surefire-reports/*.xml')
        slackNotifier {
            notifyAborted(true)
            notifyEveryFailure(true)
            notifyNotBuilt(false)
            notifyUnstable(false)
            notifyBackToNormal(true)
            notifySuccess(true)
            notifyRepeatedFailure(false)
            startNotification(false)
            includeTestSummary(false)
            includeCustomMessage(false)
            customMessage(null)
            sendAs(null)
            commitInfoChoice('NONE')
            teamDomain(null)
            authToken(null)
        }
    }
}
````

### üß© ¬øQu√© hace este c√≥digo DSL Groovy?

Este script define un job de Jenkins completamente desde c√≥digo. Lo m√°s importante que realiza es:

#### üîß 1. Creaci√≥n del Job

- Crea un job llamado `java-app-con-maven-dsl`.
- Le asigna una descripci√≥n visible en la UI.

#### üì• 2. Configuraci√≥n del SCM (Git)

- Clona el repositorio: https://github.com/magadiflo/simple-java-maven-app.git
- Usa la rama `master`.
- Registra nombre y correo para identificar los commits en Jenkins (metadatos).

#### üèóÔ∏è 3. Ejecuci√≥n de Builds con Maven

El core del job para Java:

- Usa la instalaci√≥n de Maven llamada `Maven en Jenkins`.
- El nombre `Maven en Jenkins` debe coincidir exactamente con la instalaci√≥n de Maven definida en:
  `Administrar Jenkins` ‚Üí `Tools` ‚Üí `Instalaciones de Maven`.
- Ejecuta dos pasos Maven:
    1. `-B -DskipTests clean package` ‚Üí compila y empaqueta el JAR sin correr tests.
    2. `test` ‚Üí ejecuta las pruebas unitarias.

> Esto reproduce el pipeline cl√°sico de proyectos Java: `compilar` ‚Üí `empaquetar` ‚Üí `probar`.

![06.png](assets/section-13/06.png)

#### üöÄ 4. Ejecuci√≥n de la aplicaci√≥n Java

- Usa un paso `shell` para lanzar el `.jar` generado.
- Ejecuta: `java -jar /var/jenkins_home/workspace/java-app-con-maven-dsl/target/my-app-1.0-SNAPSHOT.jar`.
- Esto demuestra que el build gener√≥ un artefacto v√°lido.

#### üì¶ 5. Publicaci√≥n de artefactos

- Guarda el `.jar` como artefacto descargable.
- Publica resultados de pruebas `JUnit` desde `surefire-reports`.

#### üí¨ 6. Notificaciones por Slack

Configura el plugin de `Slack` para enviar notificaciones seg√∫n el resultado del job (`fallo`, `√©xito`, `inestable`,
`abortado`, etc.).

#### üéØ Resumen breve

El script crea un job completo que:

- Clona un proyecto Java/Maven desde Git
- Compila y empaqueta la aplicaci√≥n
- Ejecuta tests
- Corre la aplicaci√≥n Java
- Publica el `.jar` y reportes de pruebas
- Notifica a Slack los resultados

> Todo esto `sin tocar la interfaz gr√°fica`, demostrando c√≥mo Job DSL convierte una configuraci√≥n manual en un proceso
> totalmente automatizado.

### üß© Colocando el c√≥digo DSL en el Seed Job

En el Seed Job entramos a: `Build Steps` ‚Üí `Process Job DSLs` ‚Üí `Use the provided DSL script` y
pegamos el c√≥digo `.groovy`.

![07.png](assets/section-13/07.png)

Guardamos los cambios.

### ‚ñ∂Ô∏è Ejecutando el Seed Job

Damos clic en `Construir ahora` en el job `seed-job-dsl-integrated`. Una vez completado el build, veremos que
Jenkins gener√≥ autom√°ticamente un nuevo job: `java-app-con-maven-dsl`

![08.png](assets/section-13/08.png)

Tambi√©n aparece correctamente en la pantalla principal:

![09.png](assets/section-13/09.png)

### üîß Verificando la configuraci√≥n generada

Ingresamos a `Configurar` dentro del job reci√©n creado (`java-app-con-maven-dsl`) y confirmamos que todas las opciones
(`SCM`, `Maven`, `Slack`, `JUnit`, `shell`, etc.) fueron aplicadas exactamente como estaban en el `c√≥digo DSL`.

![10.png](assets/section-13/10.png)

### ‚ñ∂Ô∏è Ejecutando el job generado

Ahora ejecutamos el job `java-app-con-maven-dsl` con `Construir ahora` y vemos que se ejecuta correctamente:

![11.png](assets/section-13/11.png)

Y en los logs aparece:

- La ejecuci√≥n de `Maven`
- El despliegue del `.jar`
- El mensaje final `SUCCESS`

![12.png](assets/section-13/12.png)

### ‚úÖ Resumen

En esta primera aproximaci√≥n:

- Creamos un Seed Job b√°sico.
- Pegamos el `DSL Groovy` directamente dentro del job.
- Generamos un job completo sin tocar la UI de Jenkins.
- Confirmamos que todo funciona: build, artefactos, test, notificaciones, ejecuci√≥n del .jar

> üåü `Este es el primer paso hacia CI/CD completamente automatizado`. En los siguientes apartados veremos formas m√°s
> profesionales y mantenibles de trabajar con DSL.

## üìÇ Creaci√≥n de Jobs con Job DSL ‚Äì Script Externo (Archivo .groovy en SCM)

En esta lecci√≥n aprenderemos la segunda forma de generar jobs usando `Job DSL`, y esta s√≠ es la forma recomendada
en entornos profesionales: `almacenar el c√≥digo DSL en un repositorio Git`, no dentro del Seed Job.

Esto nos da:

- ‚úîÔ∏è Versionamiento
- ‚úîÔ∏è Revisi√≥n por Pull Requests
- ‚úîÔ∏è Auditor√≠a
- ‚úîÔ∏è Reproducibilidad
- ‚úîÔ∏è Colaboraci√≥n entre equipos

En resumen: **es como realmente trabajan las empresas.**

### üå± 1. Crear el Seed Job

Creamos un nuevo job de tipo Freestyle: `seed-job-dsl-external`.

![13.png](assets/section-13/13.png)

### üîó 2. Configurar SCM para obtener el archivo .groovy

Entramos a `Configurar` ‚Üí `Origen del c√≥digo fuente`, seleccionamos `Git` y colocamos nuestro repositorio forkeado:
https://github.com/magadiflo/simple-java-maven-app

![14.png](assets/section-13/14.png)

Esto permitir√° a Jenkins clonar el repo y acceder al archivo que contiene el DSL.

### ‚öôÔ∏è 3. Configurar Job DSL desde archivo externo

Vamos a `Build Steps` ‚Üí `Process Job DSLs`. Esta vez en lugar de usar `Use the provided DSL script`, seleccionamos:
`Look on Filesystem` y colocamos la ruta del archivo `Groovy` dentro del repo: `DSL/javamavenDSL2.groovy`.

![15.png](assets/section-13/15.png)

Esto le indica a Jenkins que el script DSL vendr√° desde el repositorio Git, no desde la UI. Guardamos el job.

### ‚ñ∂Ô∏è 4. Ejecutar el Seed Job

- Construimos: `seed-job-dsl-external`.
- Al finalizar, veremos que se gener√≥ autom√°ticamente el nuevo job: `java-app-con-maven-dsl-v2`.

![16.png](assets/section-13/16.png)

Esto confirma que Jenkins proces√≥ correctamente el archivo `.groovy` del repositorio.

### üß© 5. Verificaci√≥n de la configuraci√≥n generada

Ingresamos a `Configurar` en el job reci√©n creado. Verificamos que toda la configuraci√≥n coincide exactamente con
lo definido en: `DSL/javamavenDSL2.groovy`.

![17.png](assets/section-13/17.png)

Esto demuestra que la configuraci√≥n proviene exclusivamente del c√≥digo versionado.

### ‚ñ∂Ô∏è 6. Ejecutar el Job generado

- Ejecutamos el job: `java-app-con-maven-dsl-v2`.
- Luego de construir y actualizar la p√°gina vemos que:
    - La ejecuci√≥n fue exitosa
    - Maven compil√≥ y prob√≥ el proyecto
    - Se generaron artefactos
    - Todo funcion√≥ exactamente como definimos en el archivo `.groovy`

![18.png](assets/section-13/18.png)

### ‚úÖ Resumen ‚Äî Inline DSL vs DSL desde SCM

| M√©todo                                     | Ventajas                                                                       | Desventajas                                                |
|--------------------------------------------|--------------------------------------------------------------------------------|------------------------------------------------------------|
| **DSL Inline (in-line)**                   | F√°cil para pruebas r√°pidas                                                     | ‚ùå No se versiona, ‚ùå No colaborativo, ‚ùå Dif√≠cil de mantener |
| **DSL desde archivo en Git (este m√©todo)** | ‚úîÔ∏è Versionado, ‚úîÔ∏è Revisiones PR, ‚úîÔ∏è Auditor√≠a, ‚úîÔ∏è Reproducible, ‚úîÔ∏è Profesional | Requiere tener el repo listo                               |

### üéØ Conclusi√≥n

Ambas formas generan los mismos resultados, pero la segunda forma es la que se utiliza en entornos empresariales,
porque:

- Permite mantener un Jenkins reproducible
- Evita configuraciones manuales
- Mantiene la infraestructura como c√≥digo (IaC)
- Facilita el mantenimiento a largo plazo
